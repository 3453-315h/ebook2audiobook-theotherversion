# =============================================================================
# Ebook2Audiobook Docker Compose Configuration
# =============================================================================
# DEFAULT: CPU-only (works on all systems)
# For GPU support, see the GPU CONFIGURATION section below
# =============================================================================

services:
  ebook2audiobook:
    # Use prebuilt image (faster) or build locally (comment out image, uncomment build)
    # image: docker.io/athomasson2/ebook2audiobook:latest
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # -----------------------------------------------------------------------
        # DEVICE CONFIGURATION - Choose ONE of the following:
        # -----------------------------------------------------------------------
        # CPU (Default - works everywhere):
        DOCKER_DEVICE_STR: '{"name": "cpu", "os": "manylinux_2_28", "arch": "x86_64", "pyvenv": ["3", "12"], "tag": "cpu"}'

        # NVIDIA CUDA (uncomment for NVIDIA GPUs):
        # DOCKER_DEVICE_STR: '{"name": "cuda", "os": "manylinux_2_28", "arch": "x86_64", "pyvenv": ["3", "12"], "tag": "cu121"}'

        # AMD ROCm (uncomment for AMD GPUs):
        # DOCKER_DEVICE_STR: '{"name": "rocm", "os": "manylinux_2_28", "arch": "x86_64", "pyvenv": ["3", "12"], "tag": "rocm6.1"}'

        # Intel XPU (uncomment for Intel GPUs):
        # DOCKER_DEVICE_STR: '{"name": "xpu", "os": "manylinux_2_28", "arch": "x86_64", "pyvenv": ["3", "12"], "tag": "xpu"}'
        # -----------------------------------------------------------------------

        # Required system dependencies - DO NOT MODIFY
        DOCKER_PROGRAMS_STR: "curl ffmpeg nodejs espeak-ng cargo rustc sox tesseract-ocr"
        ISO3_LANG: "eng"

    container_name: ebook2audiobook
    working_dir: /app

    # Startup command - installs deep-translator and launches the app
    entrypoint: [ "sh", "-c", "pip install deep-translator && python app.py --script_mode full_docker" ]
    command: [] # Add extra arguments here, e.g., ["--share"] or ["--headless", "--ebook", "book.epub"]

    tty: true
    stdin_open: true

    ports:
      - 7860:7860 # Web UI port

    volumes:
      - ./:/app # Maps local directory to container
      - ./lib:/app/lib # Ensures lib changes are reflected
    # =========================================================================
    # GPU CONFIGURATION (Optional - uncomment the section for your GPU)
    # =========================================================================

    # -------------------------------------------------------------------------
    # NVIDIA GPU (requires NVIDIA Container Toolkit)
    # Uncomment the following lines for NVIDIA GPU support:
    # -------------------------------------------------------------------------
    # runtime: nvidia
    # environment:
    #   - NVIDIA_VISIBLE_DEVICES=all
    #   - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

    # -------------------------------------------------------------------------
    # AMD ROCm GPU (Linux only)
    # Uncomment the following lines for AMD GPU support:
    # -------------------------------------------------------------------------
    # devices:
    #   - /dev/kfd
    #   - /dev/dri
    # group_add:
    #   - video
    #   - render
    # environment:
    #   # HSA_OVERRIDE_GFX_VERSION - Set based on your GPU architecture:
    #   # Vega 56/64:      HSA_OVERRIDE_GFX_VERSION=9.0.0
    #   # Vega VII:        HSA_OVERRIDE_GFX_VERSION=9.0.6
    #   # RDNA1 (RX 5000): HSA_OVERRIDE_GFX_VERSION=10.1.0
    #   # RDNA2 (RX 6000): HSA_OVERRIDE_GFX_VERSION=10.3.0
    #   # RDNA3 (RX 7000): HSA_OVERRIDE_GFX_VERSION=11.0.0
    #   - HSA_OVERRIDE_GFX_VERSION=10.3.0

    # -------------------------------------------------------------------------
    # Intel XPU (Linux only)
    # Uncomment the following lines for Intel GPU support:
    # -------------------------------------------------------------------------
    # devices:
    #   - /dev/dri

    # =============================================================================
    # QUICK START EXAMPLES:
    # =============================================================================
    # 1. CPU-only (default):    docker-compose up -d --build
    # 2. View logs:             docker logs -f ebook2audiobook
    # 3. Stop:                  docker-compose down
    # 4. Rebuild after changes: docker-compose up -d --build --force-recreate
    #
    # For headless mode, add to command: ["--headless", "--ebook", "mybook.epub"]
    # =============================================================================
